<!DOCTYPE html>
<html>
<head>
    <title>GitSniffer</title>

    <link rel="apple-touch-icon" sizes="120x120" href="favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicons/favicon-16x16.png">
    <link rel="manifest" href="favicons/manifest.json">
    <link rel="mask-icon" href="favicons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="theme-color" content="#ffffff">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/data.js"></script>
    <script src="https://code.highcharts.com/modules/drilldown.js"></script>

    <link href='http://fonts.googleapis.com/css?family=Lato:100,300,400,700' rel='stylesheet' type='text/css'>
    <link href='css/main.css' rel='stylesheet' type='text/css'>
</head>
<body>
<script>

    $(function () {

        Highcharts.setOptions({
            colors: ['#525563', '#74828e', '#96aabb', '#97c0cd', '#b8b4b0', '#cfcac6', '#c05c58', '#e17f7c', '#e1d18f', '#f2e2cd']
        });

        // ------------------
        // TOP RISKY APPS
        // ------------------
        fetch('/top_risky_repos').then(function (res) {
            return res.json();
        }).then(function (data) {

            function getReposData() {
                var _data = []
                data.forEach(function (repo) {
                    _data.push({
                        name: repo["name"],
                        y: repo["count"]
                    })
                });
                return _data;
            }

            Highcharts.chart('topRiskyRepos', {
                chart: {
                    type: 'column'
                },
                title: {
                    text: ''
                },
                credits: {
                    enabled: false
                },
                xAxis: {
                    type: 'category'
                },
                yAxis: {
                    allowDecimals: false,
                    title: {
                        text: ''
                    }

                },
                legend: {
                    enabled: false
                },
                plotOptions: {
                    series: {
                        borderWidth: 0,
                        dataLabels: {
                            enabled: true
                        }
                    }
                },

                tooltip: {
                    enabled: false,
                    headerFormat: '',
                    pointFormat: '<span style="font-size:15px;">{point.name}</span><br/><span style="font-size:13px">Num of files:<b>{point.y}</b></span></span>'
                },

                series: [{
                    maxPointWidth: 70,
                    name: 'Repo',
                    colorByPoint: true,
                    data: getReposData()
                }]
            });
        });


        // ------------------
        // OVER TIME
        // ------------------
        fetch('/over_time').then(function (res) {
            return res.json();
        }).then(function (data) {
            var overtimeDates = getOvertimeDate();
            function getOvertimeDate() {
                var _data = data.reduce(function (a, b) {
                    if (a.indexOf(b.detected_on.substring(0, b.detected_on.indexOf("T"))) == -1) {
                        a.push(b.detected_on.substring(0, b.detected_on.indexOf("T")));
                    } else {

                    }
                  return a;
                }, []);

                return _data;
            }

            var overtimeCount = getOvertimeCount();
            function getOvertimeCount() {
                var _data = []
                overtimeDates.forEach(function(item) {
                    _data.push(data.filter(filterdate(item)).length);
                });
                return _data;
            }

            function filterdate(date) {
                return function(item) {
                    return item.detected_on.substring(0, item.detected_on.indexOf("T")) === date;
                }
            }

            Highcharts.chart('vulnerabilitiesOverTime', {
                chart: {
                    type: 'line'
                },
                title: {
                    text: ''
                },
                credits: {
                    enabled: false
                },
                xAxis: {
                    categories: overtimeDates
                },
                yAxis: {
                    allowDecimals: false,
                    title: {
                        text: ''
                    }
                },
                plotOptions: {
                    line: {
                        dataLabels: {
                            enabled: true
                        },
                        enableMouseTracking: false
                    }
                },
                series: [{
                    name: 'Number of files',
                    data: overtimeCount
                }]
            });


        });

    });
</script>
<header>
    <div class="main-header">
        <div class="logo">GitSniffer</div>
        <div class="slogen">Sniffs for vulnerabilities in your Git repositories</div>
    </div>
</header>
<section class="main-container">
    <section class="main">
        <div class="panel">
            <h1>Top 10 Risky Repos</h1>
            <h5>Git Repositories containing the most risky files</h5>
            <div class="chart-container">
                <div id="topRiskyRepos" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
            </div>
        </div>
        <div class="panel">
            <h1>Vulnerabilities over time</h1>
            <h5>Number of risky files sniffed over time</h5>
            <div class="chart-container">
                <div id="vulnerabilitiesOverTime" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
            </div>
        </div>
    </section>
</section>
</body>
</html>		